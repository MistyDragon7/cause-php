<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Register for the Cause</title>

        <!-- intl-tel-input CSS -->
        <link
            rel="stylesheet"
            href="https://cdn.jsdelivr.net/npm/intl-tel-input@18.1.1/build/css/intlTelInput.min.css"
        />

        <!-- country-select-js CSS -->
        <link
            rel="stylesheet"
            href="https://cdn.jsdelivr.net/npm/country-select-js@2.0.1/build/css/countrySelect.min.css"
        />

        <style>
            body {
                font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
                background: linear-gradient(65deg, #d16e30 0%, #ebcc5d 100%);
                display: flex;
                justify-content: center;
                align-items: center;
                min-height: 100vh;
                margin: 0;
                padding: 20px;
                overflow-x: hidden;
                overflow-y: auto;
            }
            p {
                word-wrap: break-word;
                overflow-wrap: break-word;
                padding-bottom: 10px;
            }
            form {
                background: white;
                padding: 35px;
                border-radius: 20px;
                box-shadow: 0 15px 30px rgba(0, 0, 0, 0.2);
                max-width: 100%;
                width: 500px;
                animation: float 5s ease-in-out infinite; /* Floating animation */
                position: relative;
            }

            @keyframes float {
                0% {
                    transform: translateY(0);
                }
                50% {
                    transform: translateY(0px); /* Move up slightly */
                }
                100% {
                    transform: translateY(0); /* Return to original position */
                }
            }

            h2 {
                color: #2c3e50;
                margin-bottom: 30px;
                font-size: 28px;
                text-align: center;
                position: relative;
            }

            h2::after {
                content: "";
                display: block;
                width: 50px;
                height: 3px;
                background: #764ba2;
                margin: 10px auto 0;
                border-radius: 2px;
            }

            .input-group {
                position: relative;
                margin-bottom: 20px;
            }

            .input-row {
                display: flex;
                gap: 10px;
                flex-wrap: wrap;
            }

            .input-row .input-group {
                flex: 1;
                min-width: 45%;
            }

            input[type="text"],
            input[type="number"],
            input[type="email"],
            input[type="tel"] {
                width: 100%;
                padding: 14px;
                border: 2px solid #e0e0e0;
                border-radius: 10px;
                font-size: 15px;
                transition: all 0.3s ease;
                box-sizing: border-box;
            }

            .country-select {
                width: 100% !important;
            }

            input:focus {
                border-color: #764ba2;
                box-shadow: 0 0 0 3px rgba(118, 75, 162, 0.1);
                outline: none;
            }

            label {
                display: flex;
                align-items: center;
                margin-bottom: 25px;
                color: #2c3e50;
                font-size: 15px;
                cursor: pointer;
            }

            input[type="checkbox"] {
                margin-right: 12px;
                width: 18px;
                height: 18px;
                accent-color: #764ba2;
            }
            .iti {
                width: 100%; /* or set a fixed width like 300px */
            }

            /* .iti__flag-container {
                width: 60px; /* narrower flag + dropdown */
            } */

            /* .iti__selected-flag {
                padding: 0 6px;
            } */

            .iti__country-list {
                max-height: 200px;
                overflow-y: auto;
                z-index: 1000;
            }
            button {
                width: 100%;
                padding: 14px;
                border: none;
                border-radius: 10px;
                font-size: 16px;
                font-weight: 600;
                cursor: pointer;
                transition: all 0.3s ease;
            }

            button:first-of-type {
                background: #667eea;
                color: white;
                margin-bottom: 15px;
            }

            button:last-of-type {
                background: #764ba2;
                color: white;
            }

            button:disabled {
                background: #cccccc;
                cursor: not-allowed;
            }

            button:not(:disabled):hover {
                transform: translateY(-2px);
                box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            }

            .message {
                padding: 12px;
                border-radius: 8px;
                margin-bottom: 20px;
                font-weight: 500;
                font-size: 14px;
                text-align: center;
            }

            .message.success {
                background-color: #d4edda;
                color: #155724;
                border: 1px solid #c3e6cb;
            }

            .message.error {
                background-color: #f8d7da;
                color: #721c24;
                border: 1px solid #f5c6cb;
            }

            .error-msg {
                font-size: 13px;
                color: #e74c3c;
                margin-top: 5px;
                display: none;
            }

            .age-error {
                font-size: 13px;
                color: #e74c3c;
                margin-top: 5px;
                display: none;
            }

            @media (max-width: 480px) {
                form {
                    width: 100%;
                    padding: 25px;
                }
            }
        </style>
    </head>

    <body>
        <form id="registration-form">
            <h2>Petition and Plea for ONE DMS on 30th, 31st and 1st January</h2>
            <p>
                Dear Sir/Madam, <br />This below, is my Guru’s direct and sacred
                instruction to us:<br />"They (the leadership of Ananda Margiis)
                will have to keep specially strict vigilance on unity and order.
                Do not allow distinctions to crop up among Ánanda Márgiis. Unity
                should be maintained even at the risk to one’s life. Do not
                under any circumstances allow individual interest to stand in
                the way of collective interest."<br />Thus I, the undersigned,
                respectfully request that my Guru’s instruction be followed, and
                permission be given for the holding of only one DMS on the above
                dates, where any Ananda Margii is welcome to attend.
            </p>

            <div class="input-row">
                <div class="input-group">
                    <input
                        type="text"
                        name="first_name"
                        placeholder="First Name"
                        required
                    />
                </div>
                <div class="input-group">
                    <input
                        type="text"
                        name="last_name"
                        placeholder="Last Name"
                        required
                    />
                </div>
            </div>

            <div class="input-group">
                <input type="number" name="age" placeholder="Age" required />
                <div id="age-error" class="age-error">
                    You must be at least 13 years old to register.
                </div>
            </div>

            <div class="input-group">
                <input type="text" name="city" placeholder="City" required />
            </div>

            <div class="input-group">
                <input
                    type="text"
                    id="country"
                    name="country"
                    placeholder="Select Country"
                    required
                />
            </div>

            <div class="input-group">
                <input
                    id="phno"
                    name="phno"
                    type="tel"
                    placeholder="Phone Number"
                    required
                />
                <div id="phone-error" class="error-msg">
                    Invalid phone number
                </div>
            </div>

            <div class="input-group">
                <input
                    type="email"
                    name="email"
                    id="email"
                    placeholder="Email"
                    required
                />
                <div id="email-error" class="error-msg">
                    Invalid email address
                </div>
            </div>

            <label>
                <input type="checkbox" name="support" id="support-checkbox" />
                I support this cause
            </label>

            <button type="button" onclick="sendOTP()">Send OTP</button>

            <div class="input-group">
                <input type="text" id="otp" placeholder="Enter OTP" />
            </div>

            <div id="feedback"></div>

            <button
                type="button"
                onclick="submitForm()"
                id="submit-button"
                disabled
            >
                Submit
            </button>
        </form>

        <!-- JS Scripts -->
        <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/intl-tel-input@18.1.1/build/js/intlTelInput.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/country-select-js@2.0.1/build/js/countrySelect.min.js"></script>

        <script>
            const phoneInput = document.querySelector("#phno");
            const emailInput = document.querySelector("#email");
            const ageInput = document.querySelector("input[name='age']");
            const phoneError = document.getElementById("phone-error");
            const emailError = document.getElementById("email-error");
            const ageError = document.getElementById("age-error");
            const feedbackDiv = document.getElementById("feedback");
            const submitButton = document.getElementById("submit-button");
            const supportCheckbox = document.getElementById("support-checkbox");

            const iti = window.intlTelInput(phoneInput, {
                initialCountry: "IN",
                separateDialCode: true,
                utilsScript:
                    "https://cdn.jsdelivr.net/npm/intl-tel-input@18.1.1/build/js/utils.js",
            });

            // Init country select
            $("#country").countrySelect({
                preferredCountries: ["in", "us", "gb"],
                defaultCountry: "in",
            });

            function validatePhone() {
                const isValid = iti.isValidNumber();
                phoneError.style.display =
                    isValid || !phoneInput.value ? "none" : "block";
                return isValid;
            }

            phoneInput.addEventListener("input", () => {
                validatePhone();
                checkFormReady();
            });

            phoneInput.addEventListener("countrychange", () => {
                validatePhone();
                checkFormReady();
            });

            emailInput.addEventListener("input", () => {
                const valid = /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(
                    emailInput.value,
                );
                emailError.style.display =
                    valid || !emailInput.value ? "none" : "block";
            });

            ageInput.addEventListener("input", () => {
                checkFormReady();
            });

            supportCheckbox.addEventListener("change", () => {
                checkFormReady();
            });

            function checkFormReady() {
                const age = parseInt(ageInput.value);
                const ageValid = !isNaN(age) && age >= 13;
                const supportChecked = supportCheckbox.checked;
                const phoneValid = iti.isValidNumber();

                ageError.style.display = ageValid ? "none" : "block";
                phoneError.style.display =
                    phoneValid || !phoneInput.value ? "none" : "block";

                submitButton.disabled = !(
                    ageValid &&
                    supportChecked &&
                    phoneValid
                );
            }

            function showMessage(message, type = "success") {
                feedbackDiv.innerHTML = `<div class="message ${type}">${message}</div>`;
            }

            async function sendOTP() {
                const email = document.getElementById("email").value;
                if (!email) {
                    showMessage("Please enter a valid email address.", "error");
                    return;
                }

                try {
                    const response = await fetch("send_otp.php", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ email }),
                    });

                    const data = await response.json();
                    if (data.status === "success") {
                        showMessage(
                            "OTP has been sent to your email address. Please check spam too!",
                            "success",
                        );
                    } else {
                        showMessage(
                            data.message || "Error sending OTP.",
                            "error",
                        );
                    }
                } catch (err) {
                    showMessage("Error sending OTP: " + err.message, "error");
                }
            }

            async function submitForm() {
                const form = document.getElementById("registration-form");
                const formData = {
                    first_name: form.querySelector('input[name="first_name"]')
                        .value,
                    last_name: form.querySelector('input[name="last_name"]')
                        .value,
                    age: form.querySelector('input[name="age"]').value,
                    city: form.querySelector('input[name="city"]').value,
                    country: form.querySelector('input[name="country"]').value,
                    phno: iti.getNumber(),
                    email: form.querySelector('input[name="email"]').value,
                    support: form.querySelector('input[name="support"]')
                        .checked,
                    otp: document.getElementById("otp").value,
                };

                if (!formData.otp) {
                    showMessage(
                        "Please enter the OTP before submitting.",
                        "error",
                    );
                    return;
                }

                try {
                    const response = await fetch("verify.php", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify(formData),
                    });

                    const data = await response.json();
                    if (data.status === "success") {
                        showMessage("Registration successful!", "success");
                        form.reset();
                        submitButton.disabled = true;
                    } else {
                        if (data.message.includes("phone number")) {
                            showMessage(
                                "The phone number is already registered.",
                                "error",
                            );
                        } else if (data.message.includes("email")) {
                            showMessage(
                                "The email is already registered.",
                                "error",
                            );
                        } else if (data.message.includes("Both")) {
                            showMessage(
                                "Both the phone number and email are already registered.",
                                "error",
                            );
                        } else {
                            showMessage(
                                data.message ||
                                    "An error occurred. Please try again.",
                                "error",
                            );
                        }
                    }
                } catch (err) {
                    showMessage(
                        "Error submitting form: " + err.message,
                        "error",
                    );
                }
            }
        </script>
    </body>
</html>
